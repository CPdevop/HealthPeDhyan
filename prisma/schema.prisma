// This is your Prisma schema file

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER & AUTH
// ============================================================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  passwordHash String?
  role         UserRole @default(USER)

  // Email verification
  emailVerified     Boolean   @default(false)
  verificationToken String?   @unique

  // Password reset
  resetToken       String?   @unique
  resetTokenExpiry DateTime?

  // Login tracking
  lastLoginAt DateTime?
  loginCount  Int       @default(0)

  // OAuth
  provider     String?   // 'google', 'facebook', 'credentials'
  providerId   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  articles      Article[]
  profile       UserProfile?
  bookmarks     Bookmark[]
  productViews  ProductView[]
  searchHistory SearchHistory[]
  lists         UserList[]

  @@index([email])
  @@index([verificationToken])
  @@index([resetToken])
  @@map("users")
}

enum UserRole {
  ADMIN
  EDITOR
  USER
}

// ============================================================================
// OTP AUTHENTICATION
// ============================================================================

model LoginOtp {
  id        String   @id @default(cuid())
  email     String
  otp       String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([otp])
  @@index([expiresAt])
  @@map("login_otps")
}

// ============================================================================
// USER PROFILE & PREFERENCES
// ============================================================================

model UserProfile {
  id     String @id @default(cuid())
  userId String @unique

  // Dietary preferences
  isVegetarian Boolean @default(false)
  isVegan      Boolean @default(false)
  isGlutenFree Boolean @default(false)
  isDairyFree  Boolean @default(false)
  isNutFree    Boolean @default(false)
  isKeto       Boolean @default(false)
  isPaleo      Boolean @default(false)

  // Health goals (stored as JSON array)
  healthGoals Json? @db.JsonB // ["weight_loss", "muscle_gain", "heart_health"]
  allergies   Json? @db.JsonB // ["peanuts", "shellfish", "soy"]

  // Preferences
  favoriteBrands    Json? @db.JsonB // Array of brand IDs
  avoidIngredients  Json? @db.JsonB // Array of ingredient names
  preferredMerchant String? // 'AMAZON', 'FLIPKART', etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_profiles")
}

// ============================================================================
// BOOKMARKS & FAVORITES
// ============================================================================

model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  productId String?
  articleId String?
  notes     String?  @db.Text
  createdAt DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  article Article? @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@unique([userId, articleId])
  @@index([userId])
  @@index([productId])
  @@index([articleId])
  @@index([createdAt])
  @@map("bookmarks")
}

// ============================================================================
// USER LISTS & COLLECTIONS
// ============================================================================

model UserList {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?  @db.Text
  isPublic    Boolean  @default(false)
  slug        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items ListItem[]
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, slug])
  @@index([userId])
  @@index([isPublic])
  @@map("user_lists")
}

model ListItem {
  id        String   @id @default(cuid())
  listId    String
  productId String?
  articleId String?
  notes     String?  @db.Text
  order     Int      @default(0)
  addedAt   DateTime @default(now())

  list    UserList @relation(fields: [listId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  article Article? @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([listId])
  @@index([productId])
  @@index([articleId])
  @@map("list_items")
}

// ============================================================================
// USER ACTIVITY TRACKING
// ============================================================================

model ProductView {
  id        String   @id @default(cuid())
  userId    String?
  productId String
  sessionId String?
  viewedAt  DateTime @default(now())

  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@index([sessionId])
  @@index([viewedAt])
  @@map("product_views")
}

model SearchHistory {
  id           String   @id @default(cuid())
  userId       String
  query        String
  filters      Json?    @db.JsonB
  resultsCount Int
  searchedAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([searchedAt])
  @@map("search_history")
}

// ============================================================================
// PRODUCTS & BRANDS
// ============================================================================

model Brand {
  id        String    @id @default(cuid())
  name      String
  slug      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]

  @@index([slug])
  @@map("brands")
}

model Category {
  id        String    @id @default(cuid())
  name      String
  slug      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]

  @@index([slug])
  @@map("categories")
}

model Product {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  brandId     String
  categoryId  String
  description String?  @db.Text
  heroImage   String?
  galleryJson Json?    @db.JsonB
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Nutrition & Ingredients
  shortSummary    String?   @db.Text
  nutritionJson   Json?     @db.JsonB
  ingredientsText String?   @db.Text
  allergensText   String?   @db.Text
  healthScore     Int       @default(0)
  searchVector    String?   @db.Text

  // Health Flags
  isPalmOilFree          Boolean @default(false)
  isArtificialColorFree  Boolean @default(false)
  isLowSugar             Boolean @default(false)
  isWholeGrain           Boolean @default(false)
  isMeetsStandard        Boolean @default(false)

  // Relations
  brand           Brand                   @relation(fields: [brandId], references: [id], onDelete: Cascade)
  category        Category                @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  badges          ProductBadge[]
  ingredientFlags ProductIngredientFlag[]
  affiliateLinks  AffiliateLink[]
  bookmarks       Bookmark[]
  listItems       ListItem[]
  views           ProductView[]

  @@index([slug])
  @@index([brandId])
  @@index([categoryId])
  @@index([isPalmOilFree])
  @@index([isArtificialColorFree])
  @@index([isLowSugar])
  @@index([isMeetsStandard])
  @@map("products")
}

// ============================================================================
// BADGES & FLAGS
// ============================================================================

model Badge {
  id          String         @id @default(cuid())
  name        String
  code        String         @unique
  description String?        @db.Text
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  products    ProductBadge[]

  @@index([code])
  @@map("badges")
}

model ProductBadge {
  id        String   @id @default(cuid())
  productId String
  badgeId   String
  rationale String?  @db.Text
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  badge   Badge   @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([productId, badgeId])
  @@index([productId])
  @@index([badgeId])
  @@map("product_badges")
}

model IngredientFlag {
  id          String                  @id @default(cuid())
  name        String
  code        String                  @unique
  description String?                 @db.Text
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  products    ProductIngredientFlag[]

  @@index([code])
  @@map("ingredient_flags")
}

model ProductIngredientFlag {
  id        String   @id @default(cuid())
  productId String
  flagId    String
  createdAt DateTime @default(now())

  product Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  flag    IngredientFlag @relation(fields: [flagId], references: [id], onDelete: Cascade)

  @@unique([productId, flagId])
  @@index([productId])
  @@index([flagId])
  @@map("product_ingredient_flags")
}

// ============================================================================
// AFFILIATE LINKS
// ============================================================================

model AffiliateLink {
  id         String            @id @default(cuid())
  productId  String
  merchant   AffiliateMerchant
  url        String
  paramsJson Json?             @db.JsonB
  isActive   Boolean           @default(true)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([merchant])
  @@map("affiliate_links")
}

enum AffiliateMerchant {
  AMAZON
  FLIPKART
  OTHER
}

// ============================================================================
// ARTICLES & BLOG
// ============================================================================

model Article {
  id           String        @id @default(cuid())
  slug         String        @unique
  title        String
  excerpt      String?       @db.Text
  bodyMarkdown String        @db.Text
  coverImage   String?
  videoUrl     String?
  category     String?
  tags         String?
  status       ArticleStatus @default(DRAFT)
  metaJson     Json?         @db.JsonB
  publishedAt  DateTime?
  canonicalUrl String?
  authorId     String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  author    User?      @relation(fields: [authorId], references: [id], onDelete: SetNull)
  bookmarks Bookmark[]
  listItems ListItem[]

  @@index([slug])
  @@index([status])
  @@index([category])
  @@index([publishedAt])
  @@map("articles")
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
}

// ============================================================================
// EVIDENCE LIBRARY
// ============================================================================

model Evidence {
  id        String   @id @default(cuid())
  title     String
  publisher String?
  year      Int?
  url       String?
  summary   String?  @db.Text
  tagsJson  Json?    @db.JsonB
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([year])
  @@map("evidence")
}

// ============================================================================
// INGREDIENTS
// ============================================================================

model Ingredient {
  id             String         @id @default(cuid())
  name           String
  slug           String         @unique
  description    String?        @db.Text
  aliasesJson    Json?          @db.JsonB
  riskLevel      RiskLevel      @default(LOW)
  referencesJson Json?          @db.JsonB
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([slug])
  @@index([riskLevel])
  @@map("ingredients")
}

enum RiskLevel {
  LOW
  MODERATE
  HIGH
}

// ============================================================================
// CONTACT MESSAGES
// ============================================================================

model ContactMessage {
  id        String              @id @default(cuid())
  name      String
  email     String
  subject   String
  message   String              @db.Text
  status    ContactMessageStatus @default(NEW)
  notes     String?             @db.Text
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([email])
  @@map("contact_messages")
}

enum ContactMessageStatus {
  NEW
  READ
  REPLIED
  ARCHIVED
}

// ============================================================================
// LABEL SCANNER
// ============================================================================

model LabelScan {
  id                String            @id @default(cuid())
  imageUrl          String
  ocrText           String?           @db.Text
  extractedData     Json?             @db.JsonB
  healthScore       Int?
  analysisResult    Json?             @db.JsonB
  status            LabelScanStatus   @default(PROCESSING)
  userId            String?
  productName       String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([userId])
  @@index([healthScore])
  @@map("label_scans")
}

enum LabelScanStatus {
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================================================
// TELEMETRY & ANALYTICS
// ============================================================================

model TelemetryEvent {
  id              String             @id @default(cuid())
  eventType       TelemetryEventType
  eventName       String
  userId          String?
  sessionId       String?
  userAgent       String?
  ipAddress       String?

  // Page/Route info
  path            String?
  referrer        String?

  // Event data
  properties      Json?              @db.JsonB

  // Performance metrics
  duration        Int?

  // Metadata
  createdAt       DateTime           @default(now())

  @@index([eventType])
  @@index([eventName])
  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
  @@index([path])
  @@map("telemetry_events")
}

enum TelemetryEventType {
  PAGE_VIEW
  USER_ACTION
  API_CALL
  ERROR
  PERFORMANCE
  FEATURE_USAGE
}
